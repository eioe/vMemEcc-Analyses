---
title: "behavior_analysis_expsub"
author: "eioe"
date: "3 2 2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



Imports & loadings:

```{r, warning=F, message=F}
library(tidyverse)
library(here)
library(Hmisc)
library(ggpubr)
library(rstatix)


source(here("Utils", "wrangle_data.R"))
source(here("Utils", "plot_behavior.R"))
```

```{r, include=F, message=F}

# set data choices:
write_fulldat_to_disk <- TRUE
get_fulldat_from_disk <- FALSE
get_data_from_sdrive <- TRUE

# If we're on my laptop, get data from virtual drive:
current_machine = Sys.info()['nodename']
if (current_machine == "DESKTOP-7DGG1KH" & get_data_from_sdrive) {
  wd = file.path('S:', 'Meine Bibliotheken', 'Experiments', 'vMemEcc')
} else {
  wd = here('../..')
}

# Need if you want to read in raw data:  
path_subject_data <- file.path(wd, "Data/SubjectData/")
# Needed if you read RDS data from disk:
path_r_data <- file.path(wd, 'Data/DataR')


if (get_fulldat_from_disk) {
  fname <- file.path(path_r_data, 'fulldat_behav.rds')
  fulldat <- readRDS(fname)
} else {
  IDs <- list.files(path_subject_data, pattern = 'VME')
  
  fulldat <- NULL
  
  for (ID in IDs) {
    for (cond in list('S001', 'S002')) {
      fname <- 'trial_results.csv'
      fpath <- file.path(path_subject_data, ID, 'Unity', cond, fname)
      
      if (!file.exists(fpath)) next
      
      dat <- read_csv(fpath) 
      dat$c_Response <- as.logical(dat$c_Response)
      fulldat <- bind_rows(fulldat, dat)
    }
  }
}

if (write_fulldat_to_disk) {
  fname <- file.path(path_r_data, 'fulldat_behav.rds')
  saveRDS(fulldat, fname)
}

# excluded subjects:
excl_subs <- c('VME_S11', 'VME_S14', 'VME_S19')

# and restructure it:
fulldat <- fulldat %>% 
             filter(! ppid %in% excl_subs) %>% 
             mutate_at(vars(ppid, 
                            c_Ecc,
                            c_CortMag,
                            c_StimN
                       ), 
                       factor) %>% 
  
             mutate_at(vars(c_ResponseCorrect, 
                            c_Change, 
                            c_Response), 
                       as.logical) %>% 
          
             drop_na(c_Response) %>% 
             
             mutate(c_ResponseCorrect = (c_Response == c_Change))
```


## Plots

Now we can take a look a the outcomes:

__Visual Memory Task Performance:__

```{r, results=T}
source(here("Utils", "plot_behavior.R"))
plot_performance(fulldat, "experiment")
```


__Change Perception Task__  
(Length of the retention interval was set to 0.)  


```{r, results=T}
plot_performance(fulldat, "perception")
```


## Statistics:

__Summarize avg. performance & run ANOVA:__
```{r message=FALSE, include=T}

sumstat <- fulldat %>% 
  filter(BlockStyle %in% c('experiment')) %>% 
  group_by(c_StimN, c_Ecc, ppid) %>% 
  summarise(mean_acc = mean(c_ResponseCorrect))

aov.res <- anova_test(data = ungroup(sumstat), 
                      dv = mean_acc, 
                      wid = ppid, 
                      within = c(c_StimN, c_Ecc))
aov.res
get_anova_table(aov.res)

sumstat %>%
  ungroup() %>% 
  pairwise_t_test(
    mean_acc ~ c_Ecc, paired = TRUE, 
    p.adjust.method = "bonferroni"
    )

```

Both main effects (memory load, eccentricity) seem to be significant, but eff. size of the eccentricity effect is pretty small. This effect also seems to be driven by the lower performance in the largest eccentricity condition. 


__Check up plots & analyses__:
```{r, include=T, message=F}

bxp <- ggboxplot(
  sumstat, x = "c_Ecc", y = "mean_acc",
  color = "c_StimN", palette = "jco"
  )
bxp


sumstat %>% 
  group_by(c_StimN, c_Ecc) %>% 
  shapiro_test(mean_acc)

ggqqplot(sumstat, "mean_acc", ggtheme = theme_bw()) +
  facet_grid(c_Ecc ~ c_StimN, labeller = "label_both")
```

Normality assumption seems to hold most widely (only violated in ecc=4 & load = 2; ie "easiest condition).


__Response Times__
```{r message=FALSE, include=T}

sumstat_RT <- fulldat %>% 
  filter(BlockStyle %in% c('experiment'), 
         c_ResponseTime < 3) %>% 
  group_by(c_StimN, c_Ecc, c_ResponseCorrect, ppid) %>% 
  summarise(mean_RT = mean(c_ResponseTime))

aov.res <- anova_test(data = ungroup(sumstat_RT), 
                      dv = mean_RT, 
                      wid = ppid, 
                      within = c(c_StimN, c_Ecc, c_ResponseCorrect))
aov.res
get_anova_table(aov.res)

bxp <- ggboxplot(
  sumstat_RT, x = c("c_ResponseCorrect", "c_StimN"), y = "mean_RT",
  color = c("c_Ecc"), palette = "jco"
  )
bxp

```

The same pattern seems to be deflected in the RTs. Faster repsonses for trials with (a) smaller memory load, (b) stimuli closer to the center of the FOV, (c) trials with correct responses. However, no significant interactions. This speaks against a speed-accuracy trade-off (where higher accuracies would be associated with slower responses) causing the effects observed in accuracy. 

```{r, include=T, message=F}

path_eeg_data <- file.path(wd, 'Data', 'DataMNE', 'EEG')
path_meanamp_data <- file.path(path_eeg_data, '07_evokeds', 'summaries')
path_apwr_data <- file.path(path_eeg_data, '08_tfr', 'summaries')


## get meanamp data: 
ma_files <- list.files(path_meanamp_data)

meanamp_dat <- NULL
for (ffile in ma_files) {
  fpath <- file.path(path_meanamp_data, ffile)
  # dat <- read_csv2(fpath, col_names = FALSE, col_types = cols(ID = col_factor(), 
  #                                                             Load = col_factor(), 
  #                                                             Ecc = col_factor(), 
  #                                                             mean_amp = col_character()))
  dat <- read.csv2(fpath, header = FALSE) 
  meanamp_dat <- bind_rows(meanamp_dat, dat)
}

meanamp_dat$V4 <- as.numeric(meanamp_dat$V4)
colnames(meanamp_dat) <- c('ppid', 'c_StimN', 'c_Ecc', 'CDA_amp')
data_CDA <- meanamp_dat %>% mutate(c_StimN = recode(c_StimN, 
                                        LoadLow = 2, 
                                        LoadHigh = 4), 
                       c_Ecc = recode(c_Ecc, 
                                      EccS = 4,
                                      EccM = 9, 
                                      EccL = 14)) 
if (False) {
  fname <- file.path(path_r_data, 'data_CDA.rds')
  saveRDS(data_CDA, fname)
}

sumstat_ma <- meanamp_dat %>% 
  group_by(c_StimN, c_Ecc, ppid) %>% 
  summarise(mean_ma = mean(CDA_amp))

aov.res <- anova_test(data = meanamp_dat, 
                      dv = mean_amp, 
                      wid = ppid, 
                      within = c(c_StimN, c_Ecc))
aov.res
get_anova_table(aov.res)

bxp <- ggboxplot(
  meanamp_dat, x = c("c_StimN"), y = "mean_amp",
  color = c("c_Ecc"), palette = "jco"
  )
bxp


```

```{r, include=T, message=F}

## get meanamp data: 
apwr_files <- list.files(path_apwr_data)

apwr_dat <- NULL
for (ffile in apwr_files) {
  fpath <- file.path(path_apwr_data, ffile)
  # dat <- read_csv2(fpath, col_names = FALSE, col_types = cols(ID = col_factor(), 
  #                                                             Load = col_factor(), 
  #                                                             Ecc = col_factor(), 
  #                                                             mean_amp = col_character()))
  dat <- read.csv2(fpath, header = FALSE) 
  apwr_dat <- bind_rows(apwr_dat, dat)
}

apwr_dat$V4 <- as.numeric(apwr_dat$V4)
colnames(apwr_dat) <- c('ppid', 'c_StimN', 'c_Ecc', 'alpha_pwr')

data_alpha <- apwr_dat %>% mutate(c_StimN = recode(c_StimN, 
                                        LoadLow = 2, 
                                        LoadHigh = 4), 
                       c_Ecc = recode(c_Ecc, 
                                      EccS = 4,
                                      EccM = 9, 
                                      EccL = 14)) 

if (False) {
  fname <- file.path(path_r_data, 'data_alpha.rds')
  saveRDS(data_alpha, fname)
}


aov.res <- anova_test(data = apwr_dat, 
                      dv = mean_alpha, 
                      wid = ppid, 
                      within = c(c_StimN, c_Ecc))
aov.res

get_anova_table(aov.res)

bxp <- ggboxplot(
  apwr_dat, x = c("c_StimN"), y = "mean_alpha",
  color = c("c_Ecc"), palette = "jco"
  )
bxp

apwr_dat %>% 
  as_tibble() %>% 
  filter(c_StimN == 'LoadLow') %>% 
  pairwise_t_test(mean_alpha ~ c_Ecc, paired = TRUE, 
    p.adjust.method = "bonferroni")

```
